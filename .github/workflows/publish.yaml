name: Secure NPM Publish

# âš ï¸ SECURITY: This workflow uses Trusted Publishers (OIDC)
# No long-lived tokens needed - authentication via GitHub identity
# Requires NPM organization setup: https://docs.npmjs.com/trusted-publishers

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
        default: "patch"
      dry_run:
        description: "Dry run (test without publishing)"
        required: false
        type: boolean
        default: false

  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  id-token: write
  pull-requests: read

jobs:
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Verify package integrity
        run: |
          echo "ðŸ“¦ Verifying package.json integrity..."
          node -e "JSON.parse(require('fs').readFileSync('package.json'))"

      - name: Install dependencies (with audit)
        run: |
          npm ci --ignore-scripts

      - name: Run security audit
        run: |
          npm audit --audit-level=moderate

      - name: Validate staking list build & tests
        run: npm test

  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: security-audit
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run tests
        run: npm test

      - name: Build staking list
        run: npm run build

      - name: Validate build output
        run: |
          set -euo pipefail

          # Check unified output files exist
          test -f "build/syrups.json"
          test -f "build/lpfarms.json"
          test -f "build/dualfarms.json"

          # Validate syrups.json structure
          node -e "
            const a=require('./build/syrups.json');
            if(!a.name||!a.version||!a.chains) throw new Error('Invalid syrups output');
            if(!a.chains['137']||!a.chains['8453']) throw new Error('Missing chains in syrups');
            if(!Array.isArray(a.chains['137'].active)) throw new Error('Invalid polygon syrups');
            if(!Array.isArray(a.chains['8453'].active)) throw new Error('Invalid base syrups');
          "

          # Validate lpfarms.json structure
          node -e "
            const a=require('./build/lpfarms.json');
            if(!a.name||!a.version||!a.chains) throw new Error('Invalid lpfarms output');
            if(!a.chains['137']||!a.chains['8453']) throw new Error('Missing chains in lpfarms');
          "

          # Validate dualfarms.json structure
          node -e "
            const a=require('./build/dualfarms.json');
            if(!a.name||!a.version||!a.chains) throw new Error('Invalid dualfarms output');
            if(!a.chains['137']||!a.chains['8453']) throw new Error('Missing chains in dualfarms');
          "

          echo "âœ… Build validation passed"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: staking-list-build
          path: build/
          retention-days: 7

  version-bump:
    name: ðŸ“ Version Bump
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'workflow_dispatch' && !inputs.dry_run
    timeout-minutes: 5

    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Configure Git
        run: |
          git config user.name "quickswap-bot"
          git config user.email "bot@quickswap.exchange"

      - name: Bump version
        id: bump
        run: |
          echo "Current version: $(node -p "require('./package.json').version")"
          npm version ${{ inputs.bump }} -m "chore(release): v%s [skip ci]"
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version bumped to: $NEW_VERSION"

      - name: Push version commit & tag
        run: |
          git push origin HEAD --follow-tags
          echo "âœ… Pushed v${{ steps.bump.outputs.new_version }}"

  publish-npm:
    name: ðŸš€ Publish to NPM
    runs-on: ubuntu-latest
    needs: [build-and-test, version-bump]
    if: |
      always() &&
      needs.build-and-test.result == 'success' &&
      (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
        (github.event_name == 'workflow_dispatch' && !inputs.dry_run && needs.version-bump.result == 'success')
      )
    timeout-minutes: 10

    environment:
      name: npm-production
      url: https://www.npmjs.com/package/@quickswap-defi/staking-list

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch latest changes (after version bump)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git fetch origin --tags --force
          git reset --hard origin/${{ github.ref_name }}
          echo "âœ… Updated to latest commit on ${{ github.ref_name }}"

      - name: Verify package version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "ðŸ“¦ Package version: $PACKAGE_VERSION"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            EXPECTED_VERSION="${{ needs.version-bump.outputs.new_version }}"
            echo "Expected version from version-bump job: $EXPECTED_VERSION"
            if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "âš ï¸ Warning: Package version doesn't match expected version"
            fi
          fi

      - name: Setup Node.js with NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: "24" # Node 24 required for OIDC publishing (npm/cli#8730)
          registry-url: "https://registry.npmjs.org/"

      - name: Update npm (required for OIDC)
        run: |
          npm install -g npm@latest
          npm --version

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: staking-list-build
          path: build/

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Rebuild (ensure consistency)
        run: npm run build

      - name: Pre-publish verification
        run: |
          echo "ðŸ“‹ Package details:"
          npm pack --dry-run
          echo ""
          echo "ðŸ“¦ Package contents:"
          npm publish --dry-run

      - name: Check if version already exists
        id: check_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "Checking if version $PACKAGE_VERSION already exists..."
          if npm view "@quickswap-defi/staking-list@$PACKAGE_VERSION" version > /dev/null 2>&1; then
            echo "âš ï¸ Version $PACKAGE_VERSION already exists in npm registry"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $PACKAGE_VERSION is new and can be published"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Publish to NPM
        if: steps.check_version.outputs.exists == 'false'
        run: |
          npm publish --access public --provenance

      - name: Skip publish (version exists)
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "â­ï¸ Skipping publish: version ${{ steps.check_version.outputs.version }} already exists in npm registry"
          echo "If you need to publish a new version, bump the version first."

      - name: Get published version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## ðŸ“¦ NPM Package Published

            **Package:** `@quickswap-defi/staking-list@${{ steps.version.outputs.version }}`

            ### Installation
            ```bash
            npm install @quickswap-defi/staking-list@${{ steps.version.outputs.version }}
            ```
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true

